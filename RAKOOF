local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()

-- 初始化
local tool = player.Backpack:FindFirstChild("StunStick") or character:FindFirstChild("StunStick")
if not tool then
	warn("找不到 StunStick 工具")
	return
end

-- 強制設定 Handle
local handle = tool:FindFirstChild("Handle")
if handle then
	handle.CanCollide = false
	handle.Size = Vector3.new(13, 500, 300)
end

-- 建立 fake hand
local fakeHand = Instance.new("Part")
fakeHand.Name = "FakeHand"
fakeHand.Size = Vector3.new(2, 2, 2)
fakeHand.Anchored = true
fakeHand.CanCollide = false
fakeHand.Transparency = 1
fakeHand.Parent = workspace

-- 把工具從角色移出（避免角色移動影響）
tool.Parent = workspace

-- 自動攻擊設定
local lastAttack = 0
local attackCooldown = 0.5
local currentRake = nil

-- 查找最新的 The_Rake
local function findLatestRake()
	local latest = nil
	local latestTime = 0

	for _, obj in ipairs(Workspace:GetChildren()) do
		if obj:IsA("Model") and obj.Name == "The_Rake" then
			if obj:FindFirstChild("Torso") then
				local time = obj:GetDebugId(1):match("%d+")
				if time and tonumber(time) > latestTime then
					latest = obj
					latestTime = tonumber(time)
				end
			end
		end
	end

	return latest
end

-- 每秒檢查是否有新的 Rake
task.spawn(function()
	while true do
		local latest = findLatestRake()
		if latest and latest ~= currentRake then
			currentRake = latest
		end
		task.wait(1)
	end
end)

-- 持續追蹤並攻擊
RunService.RenderStepped:Connect(function()
	if currentRake and currentRake:FindFirstChild("Torso") then
		local torso = currentRake.Torso
		local targetPos = torso.CFrame * CFrame.new(3, 0, 0)
		fakeHand.CFrame = targetPos

		if handle then
			handle.CFrame = fakeHand.CFrame
		end

		if tick() - lastAttack >= attackCooldown then
			if tool and tool:FindFirstChild("Activate") then
				tool:Activate()
				lastAttack = tick()
			end
		end
	end
end)
